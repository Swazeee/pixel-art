<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Art Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = window.__app_id || 'pixel-art-gen';

        window.db = db;
        window.auth = auth;
        window.appId = appId;
        window.collection = collection;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDocs = getDocs;
        window.deleteDoc = deleteDoc;

        signInAnonymously(auth).catch((error) => console.error("Auth failed:", error));

        onAuthStateChanged(auth, (user) => {
            const userDisplay = document.getElementById('userDisplay');
            const saveCloudBtn = document.getElementById('saveCloudBtn');
            const openProjectsBtn = document.getElementById('openProjectsBtn');
            if (user) {
                const shortId = user.uid.slice(-6).toUpperCase();
                userDisplay.textContent = `PLAYER #${shortId}`;
                saveCloudBtn.classList.remove('hidden');
                openProjectsBtn.classList.remove('hidden');
                window.currentUser = user;
            }
        });
    </script>
    <style>
        body {
            background-color: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%), 
                radial-gradient(at 100% 0%, rgba(168, 85, 247, 0.15) 0px, transparent 50%);
            color: #f8fafc;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            overflow-x: hidden;
        }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 99px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .checkerboard-bg { background-color: #020617; }

        .input-group {
            background-color: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; transition: all 0.2s;
        }
        .input-group:focus-within {
            border-color: #818cf8; box-shadow: 0 0 0 1px #818cf8; background-color: #0f172a;
        }
        input[type="text"], input[type="number"], select {
            background: transparent; border: none; color: #e2e8f0; font-size: 0.75rem; font-weight: 500; outline: none; width: 100%; padding: 0.75rem;
        }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%;
            background: #818cf8; cursor: pointer; margin-top: -5px;
            box-shadow: 0 0 0 2px #1e1b4b; transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px; }

        .canvas-container {
            image-rendering: pixelated; width: 100%; height: 100%; overflow: auto; 
            background-color: #020617; display: grid; place-items: center;
            min-height: 500px; border-radius: 0.75rem; border: 2px dashed #334155; position: relative;
        }

        #previewContainer:not(.fullscreen-active) canvas { object-fit: contain; }

        .fullscreen-active {
            position: fixed !important; inset: 0 !important; z-index: 100 !important;
            background-color: #020617 !important; padding: 0 !important;
            display: flex !important; flex-direction: column !important; border-radius: 0 !important;
        }
        .fullscreen-active .preview-wrapper {
            flex-grow: 1; border: none; border-radius: 0; overflow: auto;
            display: flex; justify-content: center; align-items: flex-start; padding: 2rem;
        }
        .fullscreen-active .toolbar-header { padding: 1rem 2rem; background: #0f172a; border-bottom: 1px solid #1e293b; }

        canvas { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6); image-rendering: pixelated; max-width: none; max-height: none; }
        #cropOverlay { position: absolute; top: 0; left: 0; cursor: crosshair; display: none; z-index: 10; }
        
        #limitNotification {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: translateY(100px) translateX(-50%); opacity: 0;
        }
        #limitNotification.show { transform: translateY(0) translateX(-50%); opacity: 1; }

        .error-overlay {
            position: absolute; inset: 0; background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(8px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20; text-align: center; padding: 2rem;
        }

        .tool-btn {
            display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.375rem 0.75rem;
            border-radius: 0.5rem; font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.05em; transition: all 0.2s;
        }
        
        .panel {
            background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .modal-bg { background-color: rgba(2, 6, 23, 0.95); backdrop-filter: blur(8px); }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col">
    <div id="limitNotification" class="fixed bottom-8 left-1/2 z-[110] bg-indigo-600 border border-indigo-400 text-white px-6 py-3 rounded-full shadow-2xl font-bold flex items-center gap-3">
        <span id="notificationText">Notification</span>
    </div>

    <!-- Projects Modal -->
    <div id="projectsModal" class="fixed inset-0 z-[120] hidden modal-bg flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl w-full max-w-4xl p-6 relative flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black text-white uppercase italic tracking-tighter">My Cloud Projects</h2>
                <button id="closeProjects" class="text-slate-500 hover:text-white p-2">✕</button>
            </div>
            <div id="projectsList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto pr-2">
                <div class="text-center text-slate-500 col-span-full py-10 italic">Loading projects...</div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto w-full flex-grow">
        <header class="mb-8 flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400 mb-1 tracking-tighter uppercase italic drop-shadow-sm">Pixel Art Generator</h1>
                <p class="text-slate-400 text-xs font-semibold tracking-wide">Professional Skap Level Converter • v2.5.2</p>
            </div>
            <div class="flex items-center gap-3">
                <div class="bg-slate-800/80 border border-slate-700 rounded-lg px-4 py-2 flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <span id="userDisplay" class="text-xs font-bold text-slate-200 tracking-wider">CONNECTING...</span>
                </div>
                <button id="openProjectsBtn" class="hidden bg-indigo-600/20 hover:bg-indigo-600/30 text-indigo-300 border border-indigo-500/30 text-xs font-bold px-4 py-2 rounded-lg transition-all uppercase flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>
                    My Projects
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="lg:col-span-1 flex flex-col panel rounded-2xl shadow-xl max-h-[85vh] overflow-hidden">
                <div class="flex-1 overflow-y-auto p-5 space-y-6">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-indigo-300 uppercase tracking-widest ml-1">1. Image Source</label>
                        <div class="checkerboard-bg border-2 border-dashed border-slate-600 rounded-xl p-6 text-center hover:border-indigo-500 transition-all cursor-pointer relative group">
                            <input type="file" id="imageInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                            <div class="pointer-events-none group-hover:scale-105 transition-transform flex flex-col items-center gap-2">
                                <div class="p-3 bg-slate-900/80 rounded-full shadow-lg backdrop-blur-sm border border-slate-700">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                </div>
                                <span class="text-[10px] text-slate-300 font-bold block bg-slate-900/80 px-2 py-1 rounded backdrop-blur-sm group-hover:text-white transition-colors">CLICK OR PASTE</span>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <label class="text-[10px] font-black text-indigo-300 uppercase tracking-widest ml-1">2. Configuration</label>
                        <div class="space-y-2">
                            <div class="input-group"><input type="text" id="levelName" placeholder="Level Name (Optional)"></div>
                            <div class="input-group"><input type="text" id="creator" placeholder="Creator Name (Optional)"></div>
                        </div>
                        <div class="space-y-4 pt-2">
                            <div>
                                <div class="flex justify-between text-[10px] uppercase font-bold text-slate-400 mb-2">
                                    <span>Grid Scale (Base 10)</span>
                                    <span id="pixelSizeVal" class="text-indigo-400 bg-indigo-950/50 px-2 py-0.5 rounded border border-indigo-500/20">10px</span>
                                </div>
                                <input type="range" id="pixelSize" min="10" max="100" step="10" value="10" class="accent-indigo-500">
                            </div>
                            <div>
                                <div class="flex justify-between text-[10px] uppercase font-bold text-slate-400 mb-2">
                                    <span>Color Blending</span>
                                    <span id="colorThresholdVal" class="text-emerald-400 bg-emerald-950/50 px-2 py-0.5 rounded border border-emerald-500/20">Low</span>
                                </div>
                                <input type="range" id="colorThreshold" min="0" max="80" step="1" value="15" class="accent-emerald-500">
                            </div>
                        </div>
                        <div class="bg-slate-900/40 p-3 rounded-xl border border-slate-700/50 space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-[10px] text-slate-400 font-bold uppercase">Spawn</span>
                                <div class="flex bg-slate-950/80 p-1 rounded-lg border border-slate-800">
                                    <button class="spawn-btn text-[9px] px-3 py-1 rounded-md bg-indigo-600 text-white font-bold shadow-sm transition-all" data-val="middle" id="btnSpawnMid">MID</button>
                                    <button class="spawn-btn text-[9px] px-3 py-1 rounded-md text-slate-500 font-bold hover:text-slate-300 transition-all" data-val="bottom" id="btnSpawnBot">BOT</button>
                                </div>
                                <input type="hidden" id="spawnMode" value="middle">
                            </div>
                            <div class="flex justify-between items-center pt-1">
                                <label for="collide" class="text-[10px] font-bold text-slate-400 uppercase cursor-pointer select-none">Solid Art</label>
                                <input type="checkbox" id="collide" class="accent-indigo-500 w-4 h-4 cursor-pointer">
                            </div>
                        </div>
                    </div>

                    <div class="space-y-3 pt-4 border-t border-slate-700/50">
                        <div class="flex justify-between items-center">
                            <label class="text-[10px] font-black text-indigo-300 uppercase tracking-widest ml-1">3. Outline</label>
                            <input type="checkbox" id="enableOutline" class="accent-indigo-500 w-4 h-4 cursor-pointer">
                        </div>
                        <div id="outlineSettings" class="hidden space-y-3 bg-slate-900/40 p-3 rounded-xl border border-slate-700/50">
                            <div class="flex justify-between items-center">
                                <span class="text-[10px] font-bold text-slate-400 uppercase">Color</span>
                                <div class="relative w-6 h-6 rounded-full overflow-hidden border border-slate-600">
                                    <input type="color" id="outlineColor" value="#000000" class="absolute -top-2 -left-2 w-10 h-10 cursor-pointer">
                                </div>
                            </div>
                            <div class="space-y-1">
                                <div class="flex justify-between text-[10px] font-bold text-slate-400 uppercase">
                                    <span>Thickness</span>
                                    <span id="borderThicknessVal" class="text-indigo-400">1px</span>
                                </div>
                                <input type="range" id="borderThickness" min="1" max="10" value="1" class="accent-indigo-500">
                            </div>
                            <div class="flex justify-between items-center">
                                <label for="outlineCollide" class="text-[10px] font-bold text-slate-400 uppercase cursor-pointer select-none">Solid Outline</label>
                                <input type="checkbox" id="outlineCollide" checked class="accent-indigo-500 w-4 h-4 cursor-pointer">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-5 pt-4 border-t border-slate-700/50 bg-slate-900/40 shrink-0 space-y-4 z-10 relative backdrop-blur-md">
                    <div class="grid grid-cols-2 gap-2 text-center">
                        <div class="bg-slate-950/50 border border-slate-800 p-2.5 rounded-xl shadow-inner">
                            <div class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1">Blocks</div>
                            <div id="blockCount" class="text-xl font-black text-indigo-400 leading-none">0</div>
                        </div>
                        <div class="bg-slate-950/50 border border-slate-800 p-2.5 rounded-xl shadow-inner">
                            <div class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1">Size</div>
                            <div id="worldDim" class="text-xs font-black text-slate-300 leading-none h-5 flex items-center justify-center">-</div>
                        </div>
                    </div>

                    <div class="input-group p-1 bg-slate-900/80">
                        <select id="limitSelector" class="bg-transparent cursor-pointer text-xs font-bold text-slate-300">
                            <option value="3000">Standard Map (&lt; 3000 Blocks)</option>
                            <option value="2000">Community Upload (&lt; 2000)</option>
                        </select>
                    </div>

                    <div class="flex gap-2">
                        <button id="downloadBtn" disabled class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-black py-4 rounded-xl transition-all disabled:opacity-50 shadow-lg text-xs uppercase tracking-wider flex items-center justify-center gap-2 group">
                            <span>JSON</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        </button>
                        <button id="saveCloudBtn" class="hidden bg-slate-800 hover:bg-indigo-600 text-white p-4 rounded-xl transition-all shadow-lg border border-slate-700/50 flex items-center justify-center" title="Save to Cloud">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-3 space-y-4">
                <div class="panel rounded-2xl shadow-2xl flex flex-col h-full" id="previewContainer">
                    <div class="flex flex-wrap items-center justify-between px-5 py-4 border-b border-slate-700/50 gap-4 toolbar-header bg-slate-900/20">
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)] animate-pulse"></span>
                                <span class="text-xs font-bold uppercase tracking-widest text-slate-200">Live Preview</span>
                            </div>
                            <div class="h-5 w-[1px] bg-slate-700/50 mx-1"></div>
                            <button id="cropToggleBtn" disabled class="tool-btn bg-slate-800/80 hover:bg-slate-700 text-slate-300 border border-slate-700/50 disabled:opacity-30">✂ Crop</button>
                            <button id="resetCropBtn" disabled class="tool-btn bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/20 disabled:opacity-30">↺ Reset</button>
                            <div class="h-5 w-[1px] bg-slate-700/50 mx-1"></div>
                            <select id="filterSelect" class="text-[10px] py-1.5 px-3 bg-slate-800/80 border border-slate-700/50 rounded-lg text-slate-300 font-bold uppercase">
                                <option value="none">No Filter</option>
                                <option value="grayscale">Grayscale</option>
                                <option value="invert">Inverted</option>
                                <option value="gameboy">GameBoy</option>
                                <option value="contrast">Contrast</option>
                                <option value="sepia">Sepia</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-3">
                            <span id="cropHelp" class="hidden text-[9px] text-amber-300 font-bold animate-pulse">DRAG TO CROP</span>
                            <span id="loadingTag" class="hidden text-[9px] text-indigo-400 font-bold animate-pulse uppercase tracking-wider">Processing...</span>
                            <div class="flex items-center gap-1 bg-slate-800/80 rounded-lg border border-slate-700/50 p-1">
                                <button id="zoomOutBtn" class="p-1 hover:text-white text-slate-400 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg></button>
                                <span id="zoomLevelDisplay" class="text-[9px] font-mono font-bold text-slate-300 w-8 text-center select-none">100%</span>
                                <button id="zoomInBtn" class="p-1 hover:text-white text-slate-400 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg></button>
                            </div>
                            <button id="fullscreenBtn" class="p-2 rounded-lg bg-slate-800/80 hover:bg-indigo-600 text-slate-400 hover:text-white border border-slate-700/50"><svg id="fsIcon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></svg></button>
                        </div>
                    </div>
                    <div class="canvas-container preview-wrapper" id="canvasWrapper">
                        <div id="placeholderText" class="absolute inset-0 flex flex-col items-center justify-center gap-4 opacity-40 select-none pointer-events-none">
                            <div class="p-4 bg-slate-800 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg></div>
                            <span class="text-sm font-bold text-slate-300 uppercase tracking-widest">Upload Image to Begin</span>
                        </div>
                        <div class="relative inline-block">
                            <canvas id="previewCanvas" class="hidden rounded shadow-2xl"></canvas>
                            <canvas id="cropOverlay" class="absolute inset-0"></canvas>
                            <div id="errorOverlay" class="error-overlay hidden rounded-lg">
                                <div class="text-red-500 text-5xl mb-4">⚠</div>
                                <h3 class="text-2xl font-black text-white mb-2 uppercase tracking-tight">Limit Exceeded</h3>
                                <p id="errorMessage" class="text-slate-300 text-sm max-w-md mb-6 font-medium"></p>
                                <div class="flex gap-3">
                                    <button onclick="autoFix('grid')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-5 py-2.5 rounded-lg text-xs font-bold uppercase shadow-lg">Increase Grid Size</button>
                                    <button onclick="autoFix('blend')" class="bg-emerald-600 hover:bg-emerald-500 text-white px-5 py-2.5 rounded-lg text-xs font-bold uppercase shadow-lg">Increase Blending</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="panel rounded-xl p-4 shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-black uppercase tracking-widest text-slate-500">JSON Output Preview</span>
                        <span id="optTag" class="text-[9px] text-emerald-400 font-mono font-bold bg-emerald-900/20 px-2 py-0.5 rounded border border-emerald-500/20">GREEDY OPTIMIZATION: ACTIVE</span>
                    </div>
                    <pre id="jsonPreview" class="text-[10px] text-emerald-400/90 overflow-x-auto p-4 bg-[#020617] rounded-lg h-24 font-mono border border-slate-800">Waiting for generation...</pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        const imageInput = document.getElementById('imageInput');
        const levelNameInput = document.getElementById('levelName');
        const creatorInput = document.getElementById('creator');
        const pixelSizeInput = document.getElementById('pixelSize');
        const pixelSizeVal = document.getElementById('pixelSizeVal');
        const colorThresholdInput = document.getElementById('colorThreshold');
        const colorThresholdVal = document.getElementById('colorThresholdVal');
        const collideCheckbox = document.getElementById('collide');
        const btnSpawnMid = document.getElementById('btnSpawnMid');
        const btnSpawnBot = document.getElementById('btnSpawnBot');
        const spawnModeInput = document.getElementById('spawnMode');
        const enableOutline = document.getElementById('enableOutline');
        const outlineSettings = document.getElementById('outlineSettings');
        const outlineColor = document.getElementById('outlineColor');
        const borderThickness = document.getElementById('borderThickness');
        const borderThicknessVal = document.getElementById('borderThicknessVal');
        const outlineCollide = document.getElementById('outlineCollide');
        const limitSelector = document.getElementById('limitSelector');
        const downloadBtn = document.getElementById('downloadBtn');
        const blockCountSpan = document.getElementById('blockCount');
        const worldDimTextSpan = document.getElementById('worldDim');
        const jsonPreview = document.getElementById('jsonPreview');
        const notification = document.getElementById('limitNotification');
        const notifText = document.getElementById('notificationText');
        const loadingTag = document.getElementById('loadingTag');
        const previewCanvas = document.getElementById('previewCanvas');
        const cropOverlay = document.getElementById('cropOverlay');
        const cropToggleBtn = document.getElementById('cropToggleBtn');
        const resetCropBtn = document.getElementById('resetCropBtn');
        const cropHelp = document.getElementById('cropHelp');
        const filterSelect = document.getElementById('filterSelect');
        const errorOverlay = document.getElementById('errorOverlay');
        const errorMessage = document.getElementById('errorMessage');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const previewContainer = document.getElementById('previewContainer');
        const fsIcon = document.getElementById('fsIcon');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const zoomLevelDisplay = document.getElementById('zoomLevelDisplay');
        const saveCloudBtn = document.getElementById('saveCloudBtn');
        const openProjectsBtn = document.getElementById('openProjectsBtn');
        const projectsModal = document.getElementById('projectsModal');
        const closeProjects = document.getElementById('closeProjects');
        const projectsList = document.getElementById('projectsList');

        let originalImage = null, croppedImage = null, currentFilter = 'none', updateTimer = null, isCropMode = false, isDragging = false, startX, startY, endX, endY, isOptimizing = false, currentZoom = 1.0, finalLevelData = null;

        const showNotif = (msg, type='info') => {
            notifText.innerText = msg;
            notification.className = `fixed bottom-8 left-1/2 z-[110] text-white px-6 py-3 rounded-full shadow-2xl font-bold flex items-center gap-3 border-2 transition-all show ${type === 'error' ? 'bg-red-600 border-red-400' : 'bg-indigo-600 border-indigo-400'}`;
            setTimeout(() => notification.classList.remove('show'), 2500);
        };
        const getLimit = () => parseInt(limitSelector.value);
        const getBlendingLabel = (val) => { if (val == 0) return "Perfect"; if (val <= 15) return "Low"; if (val <= 30) return "Medium"; if (val <= 50) return "High"; return "Extreme"; };
        const updateZoomDisplay = () => { zoomLevelDisplay.innerText = Math.round(currentZoom * 100) + '%'; if (originalImage) applyZoomStyles(); };
        const updateSpawnUI = (mode) => {
            spawnModeInput.value = mode;
            if (mode === 'middle') { btnSpawnMid.classList.add('bg-indigo-600', 'text-white'); btnSpawnMid.classList.remove('text-slate-500'); btnSpawnBot.classList.remove('bg-indigo-600', 'text-white'); btnSpawnBot.classList.add('text-slate-500'); } 
            else { btnSpawnBot.classList.add('bg-indigo-600', 'text-white'); btnSpawnBot.classList.remove('text-slate-500'); btnSpawnMid.classList.remove('bg-indigo-600', 'text-white'); btnSpawnMid.classList.add('text-slate-500'); }
            triggerUpdate();
        };
        const triggerUpdate = () => { if (!originalImage) return; clearTimeout(updateTimer); loadingTag.classList.remove('hidden'); updateTimer = setTimeout(() => { updatePreview(); generateData(); loadingTag.classList.add('hidden'); }, 150); };
        
        const loadFile = (file) => { const r = new FileReader(); r.onload = (e) => { const i = new Image(); i.onload = () => { originalImage = i; croppedImage = null; document.getElementById('placeholderText').classList.add('hidden'); previewCanvas.classList.remove('hidden'); cropToggleBtn.disabled = false; resetCropBtn.disabled = true; currentZoom = 1.0; updateZoomDisplay(); triggerUpdate(); }; i.src = e.target.result; }; r.readAsDataURL(file); };
        imageInput.addEventListener('change', (e) => { if (e.target.files[0]) loadFile(e.target.files[0]); });
        window.addEventListener('paste', (e) => { if (e.clipboardData.files[0]) loadFile(e.clipboardData.files[0]); });
        
        btnSpawnMid.addEventListener('click', () => updateSpawnUI('middle')); btnSpawnBot.addEventListener('click', () => updateSpawnUI('bottom'));
        pixelSizeInput.addEventListener('input', () => { pixelSizeVal.innerText = `${pixelSizeInput.value}px`; triggerUpdate(); });
        colorThresholdInput.addEventListener('input', () => { colorThresholdVal.innerText = getBlendingLabel(colorThresholdInput.value); triggerUpdate(); });
        limitSelector.addEventListener('change', () => { triggerUpdate(); });
        levelNameInput.addEventListener('input', triggerUpdate); creatorInput.addEventListener('input', triggerUpdate);
        enableOutline.addEventListener('change', () => { outlineSettings.classList.toggle('hidden', !enableOutline.checked); triggerUpdate(); });
        outlineColor.addEventListener('input', triggerUpdate); borderThickness.addEventListener('input', () => { borderThicknessVal.innerText = `${borderThickness.value}px`; triggerUpdate(); });
        outlineCollide.addEventListener('change', triggerUpdate); collideCheckbox.addEventListener('change', triggerUpdate);
        filterSelect.addEventListener('change', (e) => { currentFilter = e.target.value; triggerUpdate(); });
        zoomInBtn.addEventListener('click', () => { if (currentZoom < 3.0) { currentZoom += 0.25; updateZoomDisplay(); } });
        zoomOutBtn.addEventListener('click', () => { if (currentZoom > 0.25) { currentZoom -= 0.25; updateZoomDisplay(); } });
        fullscreenBtn.addEventListener('click', () => { previewContainer.classList.toggle('fullscreen-active'); const isFs = previewContainer.classList.contains('fullscreen-active'); fsIcon.innerHTML = isFs ? '<path d="M4 14h6v6"/><path d="M20 10h-6V4"/><path d="M14 10l7-7"/><path d="M3 21l7-7"/>' : '<path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/>'; document.body.style.overflow = isFs ? 'hidden' : ''; if (isCropMode) syncOverlay(); });

        function applyFilter(r, g, b) { if (currentFilter === 'none') return [r, g, b]; if (currentFilter === 'grayscale') { const v = 0.3 * r + 0.59 * g + 0.11 * b; return [v, v, v]; } if (currentFilter === 'invert') return [255-r, 255-g, 255-b]; if (currentFilter === 'gameboy') { const avg = (r+g+b)/3; if(avg < 64) return [15, 56, 15]; if(avg < 128) return [48, 98, 48]; if(avg < 192) return [139, 172, 15]; return [155, 188, 15]; } if (currentFilter === 'contrast') { const f = (259 * (128 + 255)) / (255 * (259 - 128)); return [(f*(r-128)+128), (f*(g-128)+128), (f*(b-128)+128)].map(v => Math.max(0, Math.min(255, v))); } if (currentFilter === 'sepia') return [(r*.393)+(g*.769)+(b*.189), (r*.349)+(g*.686)+(b*.168), (r*.272)+(g*.534)+(b*.131)]; return [r, g, b]; }
        function hexToRgb(hex) { const res = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return res ? [parseInt(res[1], 16), parseInt(res[2], 16), parseInt(res[3], 16)] : [0, 0, 0]; }
        function applyZoomStyles() { if(!previewCanvas) return; const w = previewCanvas.width, h = previewCanvas.height, gridSize = parseInt(pixelSizeInput.value); previewCanvas.style.width = (w * gridSize * currentZoom) + 'px'; previewCanvas.style.height = (h * gridSize * currentZoom) + 'px'; if(isCropMode) syncOverlay(); }
        
        function updatePreview() {
            const img = croppedImage || originalImage; if (!img) return;
            const gridSize = parseInt(pixelSizeInput.value), blend = parseInt(colorThresholdInput.value), doOutline = enableOutline.checked, border = parseInt(borderThickness.value), oRgb = hexToRgb(outlineColor.value);
            const sampleW = Math.ceil(img.width / gridSize), sampleH = Math.ceil(img.height / gridSize);
            const canvasW = doOutline ? sampleW + (border * 2) : sampleW, canvasH = doOutline ? sampleH + (border * 2) : sampleH;
            previewCanvas.width = canvasW; previewCanvas.height = canvasH; applyZoomStyles();
            const ctx = previewCanvas.getContext('2d'), temp = document.createElement('canvas'); temp.width = sampleW; temp.height = sampleH;
            const tCtx = temp.getContext('2d'); tCtx.drawImage(img, 0, 0, sampleW, sampleH); const data = tCtx.getImageData(0, 0, sampleW, sampleH).data;
            const palette = [], grid = Array(sampleH).fill(null).map(() => Array(sampleW).fill(null));
            for (let i = 0; i < data.length; i += 4) { if (data[i+3] < 20) continue; const x = (i/4)%sampleW, y = Math.floor((i/4)/sampleW); let [r, g, b] = applyFilter(data[i], data[i+1], data[i+2]); if (blend > 0) { const m = palette.find(p => Math.sqrt((r-p.r)**2 + (g-p.g)**2 + (b-p.b)**2) < blend); if (m) { r = m.r; g = m.g; b = m.b; } else { palette.push({r, g, b}); } } grid[y][x] = {r, g, b}; }
            const output = ctx.createImageData(canvasW, canvasH);
            for(let y=0; y<canvasH; y++) { for(let x=0; x<canvasW; x++) { const idx = (y * canvasW + x) * 4, rx = doOutline ? x-border : x, ry = doOutline ? y-border : y; const cell = (rx>=0 && ry>=0 && rx<sampleW && ry<sampleH) ? grid[ry][rx] : null; if (cell) { output.data[idx]=cell.r; output.data[idx+1]=cell.g; output.data[idx+2]=cell.b; output.data[idx+3]=255; } else if (doOutline) { let isB = false; for(let dy=-border;dy<=border;dy++) { for(let dx=-border;dx<=border;dx++) { const nx=rx+dx, ny=ry+dy; if(nx>=0 && ny>=0 && nx<sampleW && ny<sampleH && grid[ny][nx]) { isB=true; break; } } if(isB) break; } if (isB) { output.data[idx]=oRgb[0]; output.data[idx+1]=oRgb[1]; output.data[idx+2]=oRgb[2]; output.data[idx+3]=255; } } } }
            ctx.putImageData(output, 0, 0);
            const sMode = spawnModeInput.value; let spX = canvasW/2, spY = canvasH/2; if (sMode === 'bottom') spY = canvasH - (doOutline ? border : 0) - 1.5;
            ctx.beginPath(); ctx.arc(spX, spY, 2.5/gridSize, 0, Math.PI*2); ctx.fillStyle = '#4ade80'; ctx.fill();
            if(isCropMode) syncOverlay();
        }

        const bannedTerms = ["badword", "offensive"]; // Replace with real list
        const containsProfanity = (text) => text && bannedTerms.some(w => text.toLowerCase().includes(w));

        function generateData() {
            if (!originalImage) return; errorOverlay.classList.add('hidden');
            const img = croppedImage || originalImage, gridSize = parseInt(pixelSizeInput.value), blend = parseInt(colorThresholdInput.value), doOutline = enableOutline.checked, border = parseInt(borderThickness.value), oRgb = hexToRgb(outlineColor.value), limit = getLimit();
            const sampleW = Math.ceil(img.width/gridSize), sampleH = Math.ceil(img.height/gridSize);
            const tCtx = document.createElement('canvas').getContext('2d'); tCtx.canvas.width = sampleW; tCtx.canvas.height = sampleH; tCtx.drawImage(img, 0, 0, sampleW, sampleH); const data = tCtx.getImageData(0, 0, sampleW, sampleH).data;
            const grid = [], palette = [];
            for(let y=0; y<sampleH; y++) { grid[y] = []; for(let x=0; x<sampleW; x++) { const i = (y*sampleW+x)*4; if(data[i+3] < 20) { grid[y][x]=null; continue; } let [r,g,b] = applyFilter(data[i], data[i+1], data[i+2]); if (blend > 0) { const m = palette.find(p => Math.sqrt((r-p.r)**2 + (g-p.g)**2 + (b-p.b)**2) < blend); if(m) { r=m.r; g=m.g; b=m.b; } else palette.push({r,g,b}); } grid[y][x] = {r,g,b, used: false}; } }
            const canvasW = doOutline ? sampleW + border*2 : sampleW, canvasH = doOutline ? sampleH + border*2 : sampleH; const fullGrid = Array(canvasH).fill(0).map(() => Array(canvasW).fill(null));
            for(let y=0; y<canvasH; y++) { for(let x=0; x<canvasW; x++) { const rx=doOutline?x-border:x, ry=doOutline?y-border:y; const cell = (rx>=0 && ry>=0 && rx<sampleW && ry<sampleH) ? grid[ry][rx] : null; if(cell) fullGrid[y][x] = { ...cell, isOutline: false }; else if(doOutline) { let isB = false; for(let dy=-border;dy<=border;dy++) { for(let dx=-border;dx<=border;dx++){ const nx=rx+dx, ny=ry+dy; if(nx>=0 && ny>=0 && nx<sampleW && ny<sampleH && grid[ny][nx]) { isB=true; break; } } if(isB) break; } if(isB) fullGrid[y][x] = { r:oRgb[0], g:oRgb[1], b:oRgb[2], used: false, isOutline: true }; } } }
            const objs = [], artCol = collideCheckbox.checked, outCol = outlineCollide.checked;
            for(let y=0; y<canvasH; y++) { for(let x=0; x<canvasW; x++) { const cell = fullGrid[y][x]; if(!cell || cell.used) continue; let w=1; while(x+w<canvasW) { const n=fullGrid[y][x+w]; if(!n || n.used || n.r!==cell.r || n.g!==cell.g || n.b!==cell.b || n.isOutline!==cell.isOutline) break; w++; } let h=1; while(y+h<canvasH) { let ok=true; for(let dx=0;dx<w;dx++) { const n=fullGrid[y+h][x+dx]; if(!n || n.used || n.r!==cell.r || n.g!==cell.g || n.b!==cell.b || n.isOutline!==cell.isOutline) { ok=false; break; } } if(!ok) break; h++; } for(let dy=0;dy<h;dy++) for(let dx=0;dx<w;dx++) fullGrid[y+dy][x+dx].used=true; objs.push({ type:"block", position:[x*gridSize, y*gridSize], size:[w*gridSize, h*gridSize], color:[cell.r, cell.g, cell.b], collide:cell.isOutline?outCol:artCol }); } }
            
            // NEW OPTIMIZATION LOGIC START
            if (objs.length > limit) {
                const MAX_GRID = 100, MAX_BLEND = 80;
                if (gridSize < MAX_GRID || blend < MAX_BLEND) {
                    if (!isOptimizing) { isOptimizing = true; showNotif("Optimizing complexity...", 'info'); }
                    let nextGrid = gridSize, nextBlend = blend;
                    if (nextBlend < MAX_BLEND) { nextBlend += 5; } 
                    else if (nextGrid < MAX_GRID) { nextGrid += 10; nextBlend = 0; }
                    
                    if (nextGrid !== gridSize || nextBlend !== blend) {
                        pixelSizeInput.value = nextGrid; pixelSizeVal.innerText = nextGrid + "px";
                        colorThresholdInput.value = nextBlend; colorThresholdVal.innerText = getBlendingLabel(nextBlend);
                        triggerUpdate(); return;
                    }
                }
                errorOverlay.classList.remove('hidden'); errorMessage.innerText = `Blocks: ${objs.length} / Limit: ${limit}.`; downloadBtn.disabled = true; blockCountSpan.className = "text-xl font-black text-red-500 leading-none";
            } else { 
                if (isOptimizing) { isOptimizing=false; showNotif("Optimization Complete", 'success'); } 
                downloadBtn.disabled=false; blockCountSpan.className="text-xl font-black text-indigo-400 leading-none"; 
            }
            // NEW OPTIMIZATION LOGIC END

            blockCountSpan.innerText = objs.length; worldDimTextSpan.innerText = `${canvasW*gridSize}x${canvasH*gridSize}`;
            let sx=canvasW*gridSize/2, sy=canvasH*gridSize/2; if(spawnModeInput.value==='bottom') sy=(canvasH-(doOutline?border:0))*gridSize - gridSize*1.5;
            finalLevelData = { settings: { name: levelNameInput.value || "Art", creator: (limit===2000?"Swazee":creatorInput.value||"Player"), spawnPosition:[sx,sy], spawnArea:"Main" }, maps:[{ name:"Main", size:[canvasW*gridSize, canvasH*gridSize], backgroundColor:[15,23,42,1], objects:objs }] };
            const str = JSON.stringify(finalLevelData, null, 2); jsonPreview.innerText = str.length>1000?str.slice(0,1000)+'...':str;
        }

        downloadBtn.addEventListener('click', () => { const b = new Blob([JSON.stringify(finalLevelData)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = (levelNameInput.value||'art')+'.json'; a.click(); });
        cropToggleBtn.addEventListener('click', () => { isCropMode = !isCropMode; cropToggleBtn.innerText = isCropMode ? "End Crop" : "Crop"; cropToggleBtn.className = isCropMode ? "tool-btn bg-amber-600 text-white" : "tool-btn bg-slate-800 text-slate-300"; cropOverlay.style.display = isCropMode ? 'block' : 'none'; cropHelp.classList.toggle('hidden', !isCropMode); if (isCropMode) syncOverlay(); });
        const syncOverlay = () => { cropOverlay.width = previewCanvas.width; cropOverlay.height = previewCanvas.height; cropOverlay.style.width = previewCanvas.style.width; cropOverlay.style.height = previewCanvas.style.height; };
        resetCropBtn.addEventListener('click', () => { croppedImage = null; resetCropBtn.disabled = true; triggerUpdate(); });
        cropOverlay.addEventListener('mousedown', e => { if(!isCropMode) return; isDragging = true; const r = cropOverlay.getBoundingClientRect(), sx = cropOverlay.width/r.width, sy = cropOverlay.height/r.height; startX = (e.clientX-r.left)*sx; startY = (e.clientY-r.top)*sy; });
        window.addEventListener('mousemove', e => { if(!isDragging || !isCropMode) return; const r = cropOverlay.getBoundingClientRect(), sx = cropOverlay.width/r.width, sy = cropOverlay.height/r.height; endX = (e.clientX-r.left)*sx; endY = (e.clientY-r.top)*sy; const ctx = cropOverlay.getContext('2d'); ctx.clearRect(0,0,cropOverlay.width,cropOverlay.height); ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(0,0,cropOverlay.width,cropOverlay.height); ctx.clearRect(startX, startY, endX-startX, endY-startY); ctx.strokeStyle = '#818cf8'; ctx.lineWidth = 2; ctx.strokeRect(startX, startY, endX-startX, endY-startY); });
        window.addEventListener('mouseup', () => { if(!isDragging || !isCropMode) return; isDragging = false; const gridSize = parseInt(pixelSizeInput.value), border = enableOutline.checked?parseInt(borderThickness.value):0; const cx = (Math.min(startX, endX)-border)*gridSize, cy = (Math.min(startY, endY)-border)*gridSize; const cw = Math.abs(endX-startX)*gridSize, ch = Math.abs(endY-startY)*gridSize; if (cw<=0 || ch<=0) return; const tc = document.createElement('canvas'); tc.width=cw; tc.height=ch; tc.getContext('2d').drawImage(croppedImage||originalImage, cx, cy, cw, ch, 0, 0, cw, ch); const n = new Image(); n.onload = () => { croppedImage=n; resetCropBtn.disabled=false; cropToggleBtn.click(); triggerUpdate(); }; n.src = tc.toDataURL(); });
        window.autoFix = (type) => { if (type === 'grid') { pixelSizeInput.value = parseInt(pixelSizeInput.value)+10; pixelSizeVal.innerText = pixelSizeInput.value+'px'; } else { colorThresholdInput.value = Math.min(80, parseInt(colorThresholdInput.value)+15); colorThresholdVal.innerText = getBlendingLabel(colorThresholdInput.value); } triggerUpdate(); };

        saveCloudBtn.addEventListener('click', async () => {
            if(!window.currentUser || !finalLevelData) return;
            const rawLevel = levelNameInput.value.trim(), rawCreator = creatorInput.value.trim();
            if (containsProfanity(rawLevel) || containsProfanity(rawCreator)) { showNotif("Inappropriate name detected.", "error"); return; }
            const finalLevelName = rawLevel || "Art", finalCreatorName = rawCreator || "Anonymous";
            
            const cloudData = JSON.parse(JSON.stringify(finalLevelData));
            cloudData.settings.name = finalLevelName; cloudData.settings.creator = finalCreatorName;

            const projectData = {
                name: finalLevelName, creator: finalCreatorName, limit: getLimit(),
                gridSize: parseInt(pixelSizeInput.value), blending: parseInt(colorThresholdInput.value),
                spawnMode: spawnModeInput.value, timestamp: Date.now(), blocks: blockCountSpan.innerText,
                jsonData: cloudData, thumb: previewCanvas.toDataURL('image/png', 0.1)
            };
            try { await window.setDoc(window.doc(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, 'projects', Date.now().toString()), projectData); showNotif("Project Saved to Cloud!", "success"); } 
            catch(e) { console.error(e); showNotif("Save Failed", "error"); }
        });

        openProjectsBtn.addEventListener('click', async () => {
            projectsModal.classList.remove('hidden'); projectsList.innerHTML = '<div class="text-center col-span-full text-slate-500 py-10">Loading...</div>';
            try {
                const querySnapshot = await window.getDocs(window.collection(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, 'projects'));
                projectsList.innerHTML = ''; const projs = [];
                querySnapshot.forEach((doc) => projs.push({id:doc.id, ...doc.data()}));
                projs.sort((a,b) => b.timestamp - a.timestamp);
                if(projs.length === 0) projectsList.innerHTML = '<div class="text-center col-span-full text-slate-500 py-10">No saved projects found.</div>';
                projs.forEach(p => {
                    const card = document.createElement('div'); card.className = "bg-slate-800 p-4 rounded-xl border border-slate-700 hover:border-indigo-500 transition-all group relative";
                    card.innerHTML = `<div class="h-32 bg-slate-900 rounded-lg mb-3 flex items-center justify-center overflow-hidden">${p.thumb ? `<img src="${p.thumb}" class="h-full w-full object-contain pixelated" style="image-rendering: pixelated;">` : '<span class="text-slate-600">No Preview</span>'}</div><h3 class="font-bold text-white text-sm mb-1 truncate">${p.name}</h3><p class="text-[10px] text-slate-400 mb-3">${new Date(p.timestamp).toLocaleDateString()} • ${p.blocks} Blocks</p><div class="flex gap-2"><button class="load-btn flex-1 bg-indigo-600 hover:bg-indigo-500 text-white text-[10px] font-bold py-2 rounded uppercase">Load</button><button class="del-btn bg-slate-700 hover:bg-red-600 text-white p-2 rounded"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div>`;
                    card.querySelector('.load-btn').onclick = () => { levelNameInput.value = p.name; creatorInput.value = p.creator; pixelSizeInput.value = p.gridSize; pixelSizeVal.innerText = p.gridSize+"px"; colorThresholdInput.value = p.blending; colorThresholdVal.innerText = getBlendingLabel(p.blending); updateSpawnUI(p.spawnMode); limitSelector.value = p.limit; if(p.thumb) { const i = new Image(); i.onload = () => { originalImage = i; croppedImage=null; triggerUpdate(); projectsModal.classList.add('hidden'); showNotif("Project Loaded"); }; i.src = p.thumb; } else { showNotif("Could not load image source", "error"); } };
                    card.querySelector('.del-btn').onclick = async (e) => { if(confirm("Delete this project?")) { await window.deleteDoc(window.doc(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, 'projects', p.id)); card.remove(); } };
                    projectsList.appendChild(card);
                });
            } catch(e) { console.error(e); projectsList.innerHTML = '<div class="text-center text-red-400 col-span-full">Error loading projects.</div>'; }
        });
        closeProjects.addEventListener('click', () => projectsModal.classList.add('hidden'));
    </script>
</body>
</html>
